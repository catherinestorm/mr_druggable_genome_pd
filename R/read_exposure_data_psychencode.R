# read in packages

library("TwoSampleMR")
library("dplyr")
library("stringr")


# environmental variables

EXPOSURE_DATA <- Sys.getenv("EXPOSURE_DATA")
OUTCOME <- Sys.getenv("OUTCOME")

START <- as.numeric(Sys.getenv("START"))
END <- as.numeric(Sys.getenv("END"))


# problematic outcomes
REMOVE <- read.table("exposures_to_remove.txt", sep = ",", header = T, colClasses = "character")
REMOVE1 <- subset(REMOVE, REMOVE$outcome == OUTCOME & REMOVE$exposure_data == EXPOSURE_DATA)


# load exposure data

exp0 <- read_exposure_data(
  filename = "eqtl_data_psychencode/psychencode_exposure_dat_snps_5kb_window.txt",
  sep = "\t",
  snp_col = "Rsid",
  beta_col = "regression_slope",
  se_col = "se",
  effect_allele_col = "ALT",
  other_allele_col = "REF",
  pval_col = "nominal_pval",
  phenotype_col = "gene.exposure",
  min_pval = 1e-400
)

# add sample size

exp0$samplesize.exposure <- 1387


# keep only a subset of genes

if (startsWith(OUTCOME, "replication_") == TRUE) {
    discovery_outcomes <- read.table("discovery_outcomes.txt")

    TO_REPLICATE <- data.frame()
    for (i in 1:nrow(discovery_outcomes)) {

        DISCOVERY_OUTCOME <- discovery_outcomes[i,]

        temp1 <- read.table(str_c("eqtlgen_", DISCOVERY_OUTCOME, "/results/full_results_liberal_r2_0.2_eqtlgen_", DISCOVERY_OUTCOME, "_significant.txt"), sep = "\t", header = T, colClasses = "character")

        temp2 <- read.table(str_c("psychencode_", DISCOVERY_OUTCOME, "/results/full_results_liberal_r2_0.2_psychencode_", DISCOVERY_OUTCOME, "_significant.txt"), sep = "\t", header = T, colClasses = "character")

        temp <- distinct(rbind(temp1, temp2))

        TO_REPLICATE <- distinct(rbind(TO_REPLICATE, temp))

    }

    END <- length(unique(exp0$exposure))
} else if (is.na(END) == TRUE) {
    TO_REPLICATE <- exp0
    END <- length(unique(exp0$exposure))
} else {
    TO_REPLICATE <- exp0
}





exp_to_keep <- unique(exp0$exposure)[START:END]
exp <- subset(exp0, (exp0$exposure %in% exp_to_keep) & !(exp0$exposure %in% REMOVE1$exposure) & (exp0$exposure %in% TO_REPLICATE$exposure))
